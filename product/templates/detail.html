{% extends 'base.html' %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock head %}
{% block content %}

<section class="detail-section">
  <div class="detail-img">
    {% for photo in article.photo.all %}
    <img class="detail-user-img" src="{{photo.image.url}}" alt="">
    {% endfor %}
  </div>
  <div class="detail-writer">
    <div class="writer">
      <div class="writer-infor">
        {% if article.writer.profile.image.url %}
        <img src="{{article.writer.profile.image.url}}" alt="" class="product-user-image"
          onerror="this.src=`{% static 'img/감자.png' %}`">
        {% else %}
        <i class="product-icon fas fa-user-circle"></i>
        {% endif %}
        <span class="writer-nickname">{{article.writer}} </span>
        <span class="writer-region">경기 배곧동</span>
        <span class="writer-region">{{article.created_at}}</span>
      </div>
      {% if user.is_authenticated %}
      <div class="writer-cheat">
        <div class="detail-product-btn">
          {% if user.pk == article.writer.pk %}
          <a href="{% url 'product:delete' article.pk %}">삭제하기</a>
          <a href="{% url 'product:edit' article.pk %}">수정하기</a>
          {% else %}
          <button class="cheat-btn">채팅하기</button>
          {% endif %}
        </div>
        <div class="like">
          <form class="like-form" action="" method="POST">
            {% csrf_token %}
            {% if is_liked %}
            <input class="like-button like-button{{article.pk}}"><i
              class="detail-like detail-like{{article.pk}} fas fa-heart liked"
              onclick="likeBtn('{{article.pk}}')"></i></input>
            {% else %}
            <input class="like-button like-button{{article.pk}}"><i
              class="detail-like detail-like{{article.pk}} fas fa-heart"
              onclick="likeBtn('{{article.pk}}')"></i></input>
            {% endif %}
          </form>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  <div class="detail-title">
    <span class="detail-product-name">{{article.name}}</span>
    <span class="detail-product-origin-price">{{article.origin_price}}원</span>
    <span class="detail-product-price">{{article.price}}원</span>
  </div>
  <div class="detail-description">
    <p>
      {{article.content}}
    </p>
  </div>
  <div class="detail-comment">
    <span>댓글</span><br>
    <form class="comment-form" action="" method="POST">
      {% csrf_token %}
      <input type="text" class="input-comment" name="comment" placeholder="댓글입력">
      <input class="comment-btn" type="submit" value="입력하기">
    </form>
    <ul class="comment-ul">
      {% for comment in comments %}
      <li class="comment-li comment-li{{comment.pk}}">
        {% if article.writer == comment.writer %}
        <span class="comment-profile-span"><img class="user-img comment-profile-img"
            src="{{comment.writer.profile.image.url}}" alt="" onerror="this.src=`{% static 'img/감자.png' %}`"><strong
            class="owner">판매자</strong><span>{{comment.created_at}}</span></span>
        {% else %}
        <span class="comment-profile-span"><img class="user-img comment-profile-img"
            src="{{comment.writer.profile.image.url}}" alt=""
            onerror="this.src=`{% static 'img/감자.png' %}`">{{comment.writer}}<span>{{comment.created_at}}</span></span>
        {% endif %}
        {% if user == comment.writer %}
        <span class="comment-content comment-content{{comment.pk}}">{{comment.content}}</span>
        <form class="delete-comment-form delete-comment-form{{comment.pk}}" action="" method="POST">
          {% csrf_token %}
          <input type="submit" class="comment-delete comment-delete{{comment.pk}}"
            onclick="commentDelete('{{comment.pk}}')"value="삭제"></input>
            <button type="submit" class="comment-content-edit comment-content-edit{{comment.pk}}"
            onclick="commentContentEditBtn('{{comment.pk}}')">수정</button>
        </form><br>
        <!-- 글 수정 폼 -->
        <form action="" method="POST" class="edit-comment-form edit-comment-form{{comment.pk}} non-display">
          {% csrf_token %}
          <input type="text" class="edit-comment edit_comment{{comment.pk}}" name="edit_text" value="{{comment.content}}">
          <input type="submit" class="edit-comment-btn" value="수정하기" onclick="commentEditBtn('{{comment.pk}}')"></input>
          <button type="submit" class="comment-edit-cancel comment-edit-cancel{{comment.pk}}"
            onclick="commentEditCancelBtn('{{comment.pk}}')">취소하기</button>
        </form>
        <!-- 글 수정 폼 -->
        {% else %}
        <span class="comment-content">{{comment.content}}</span>
        <span class="comment-reply comment-reply{{comment.pk}}" onclick="commentReply('{{comment.pk}}')">답글</span>
        {% endif %}

        <ul class="recomment-ul recomment-ul{{comment.pk}}">
          {% for recomment in comment.re_comment.all %}
          <li class="recomment-li recomment-li{{recomment.pk}}">
            {% if article.writer == recomment.writer %}
            <span class="comment-profile-span"><img class="user-img comment-profile-img"
                src="{{recomment.writer.profile.image.url}}" alt=""
                onerror="this.src=`{% static 'img/감자.png' %}`"><strong class="owner">판매자</strong>
              <span>{{recomment.created_at}}</span> </span>
            {% else %}
            <span class="comment-profile-span"><img class="user-img comment-profile-img"
                src="{{recomment.writer.profile.image.url}}" alt=""
                onerror="this.src=`{% static 'img/감자.png' %}`">{{comment.writer}}<span>{{recomment.created_at}}</span></span>
            {% endif %}
            {% if user == recomment.writer %}
            <span class="comment-content">{{recomment.content}}</span>
            <form class="delete-recomment-form delete-recomment-form{{recomment.pk}}" action="" method="POST">
            {% csrf_token %}
              <span class="recomment-delete recomment-delete{{recomment.pk}}"
              onclick="reCommentDelete('{{recomment.pk}}')">삭제</span>
            </form>
            {% else %}
            <span class="comment-content">{{recomment.content}}</span>
            <span class="comment-reply comment-reply{{comment.pk}}" onclick="commentReply('{{comment.pk}}')">답글</span>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        <form action="" method="POST" class="recomment-form{{comment.pk}} non-display"
          onsubmit="recommentForm('{{comment.pk}}')">
          {% csrf_token %}
          <textarea type="text" class="input-re-comment input-re-comment{{comment.pk}}" name="re_comment"
            placeholder="댓글입력"></textarea>
          <div class="input-re-comment-input">
            <input class="re-comment-btn re-comment-btn{{comment.pk}}" type="submit" value="입력하기" ">
            <input class=" re-comment-btn re-comment-cancel-btn{{comment.pk}}" type="submit" value="취소하기"
              onclick="reCommentCancelBtn('{{comment.pk}}')">
          </div>
        </form>
      </li>
      {% endfor %}
    </ul>
  </div>
</section>

{% endblock content %}

{% block script %}
<!-- <script type="text/javascript" src="{% static 'js/detail/script.js' %}"></script> -->
<script>

  function commentReply(comment_pk) {
    document.querySelector(`.recomment-form${comment_pk}`).classList.remove('non-display');
  }


  function likeBtn(article_pk) {

    let likeCsrfValue = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    let param = {
      'article_pk': article_pk,
    }
    fetch("{% url 'social:like' %}", {
      method: 'POST',
      headers: {
        "X-CSRFToken": likeCsrfValue,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify(param),
    }).then(function (response) {
      console.log('readdss', response)
      return response.json()
    }).then(function (data) {
      let likedIcon = document.querySelector(`.detail-like${data.article_pk}`);
      if (data.is_liked) {
        likedIcon.classList.add('liked');
      }
      else {
        likedIcon.classList.remove('liked');
      }

    }).catch((error) => {
      console.log('error', error);
    })
  }

  // comment ajax


  let $commentForm = document.querySelector('.comment-form');

  $commentForm.addEventListener('submit', submitComment);

  function submitComment(e) {
    e.preventDefault();
    let content = document.querySelector('.input-comment').value;
    if (content == '') {
      return
    }
    let param = {
      'article_pk': '{{article.pk}}',
      'content': content,
      'user_pk': '{{request.user.pk}}',
      'owner_pk': '{{article.writer.pk}}'
    }
    // console.log(param)
    let csrfValue = document.getElementsByName("csrfmiddlewaretoken")[0].value;

    // ajax통신
    fetch("{% url 'social:comment' %}", {
      method: 'POST',
      headers: {
        "X-CSRFToken": csrfValue,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify(param),
    }).then(function (response) {
      console.log('reass', response)
      return response.json()
    }).then(function (data) {
      let data_id = data.comment_obj.id
      $commentForm.reset()


      if ('{{article.writer.pk}}' == data.writer_pk || data.writer_pk == '{{request.user.pk}}') {
        document.querySelector('.comment-ul').innerHTML += `
      <li class="comment-li comment-li${data_id}">
        <span class="comment-profile-span"><img class="user-img user_img${data_id} comment-profile-img"
          src="{{article.writer.profile.image.url}}" alt="" onerror="this.src='{% static 'img/감자.png' %}'"><strong
          class="owner">판매자</strong><span>${data.comment_obj.created_at}</span></span>
          <span class="comment-content comment-content${data_id}">${data.comment_obj.content}</span>
          <form class="delete-comment-form delete-comment-form${data_id}" action="" method="POST">
        <input type="submit" class="comment-delete comment-delete${data_id}" onclick="commentDelete('${data_id}')"value="삭제">
        <button type="submit" class="comment-content-edit comment-content-edit${data_id}"
            onclick="commentContentEditBtn('${data_id}')">수정</button>
        </form>
      <form action="" method="POST" class="edit-comment-form edit-comment-form${data_id} non-display">
          {% csrf_token %}
          <input type="text" class="edit_comment${data_id}" name="edit_text" value="${data.comment_obj.content}">
          <input type="submit" class="edit-comment-btn" value="수정하기" onclick="commentEditBtn('${data_id}')"></input>
          <button type="submit" class="comment-edit-cancel comment-edit-cancel${data_id}"
            onclick="commentEditCancelBtn('${data_id}')">취소하기</button>
        </form>
          <form action="" method="POST"
          class="recomment-form${data_id} non-display" onsubmit="recommentForm('${data_id}')>
          {% csrf_token %}
          <textarea type="text" class="input-re-comment input-re-comment${data_id}" name="re_comment"
          placeholder="댓글입력"></textarea>
          <div class="input-re-comment-input">
            <input class="re-comment-btn re-comment-btn${data_id}" type="submit" value="입력하기"
            ">
            <input class="re-comment-btn re-comment-cancel-btn${data_id}" type="submit" value="취소하기"
            onclick="reCommentCancelBtn('${data_id}')">
            </div>
            </form>
            </li>
            `
      }
      else if ('{{article.writer.pk}}' !== data.writer_pk) {
        document.querySelector('.comment-ul').innerHTML += `
            <li class="comment-li comment-li${data_id}">
              <span class="comment-profile-span"><img class="user-img user_img${data_id} comment-profile-img"
                src="${data.user_img}" alt=""
                onerror="this.src='{% static 'img/감자.png' %}'">${data.user}<span>${data.comment_obj.created_at}</span></span>
                <span class="comment-content ">${data.comment_obj.content}</span>
                <form class="delete-comment-form" action="" method="POST">
        <input type="submit" class="comment-delete comment-delete${data_id}" onclick="commentDelete(${data_id})"value="삭제">
      </form>
                <form action="" method="POST"
                class="recomment-form${data_id} non-display">
                {% csrf_token %}
                <textarea type="text" class="input-re-comment input-re-comment${data_id}" name="re_comment"
                placeholder="댓글입력"></textarea>
                <div class="input-re-comment-input">
                  <input class="re-comment-btn re-comment-btn${data_id}" type="submit" value="입력하기"
                  ">
                  <input class="re-comment-btn re-comment-cancel-btn${data_id}" type="submit" value="취소하기"
                  onclick="reCommentCancelBtn('${data_id}')">
                  </div>
                  </form>
                  </li>
                  `
      }
 


    }).catch((error) => {
      console.log('error', error);
    })


  }

  // 재댓글 취소하기 버튼
  function reCommentCancelBtn(comment_pk) {
    event.preventDefault();
    document.querySelector(`.recomment-form${comment_pk}`).classList.add('non-display');
  }


  function recommentForm(comment_pk) {
    event.preventDefault();

    if (document.querySelector(`.input-re-comment${comment_pk}`).value == '') {
      return
    }
    let recommentCsrfValue = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    let recomment = document.querySelector(`.input-re-comment${comment_pk}`).value;
    document.querySelector(`.recomment-form${comment_pk}`).classList.add('non-display');
    let param = {
      // 'article_pk': article_pk,
      'user_pk': '{{request.user.pk}}',
      'writer_pk': '{{article.writer.pk}}',
      'comment_pk': comment_pk,
      're_comment': recomment,
    }
    fetch("{% url 'social:re_comment' %}", {
      method: 'POST',
      headers: {
        "X-CSRFToken": recommentCsrfValue,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify(param),
    }).then(function (response) {
      // console.log('reass', response)
      return response.json()
    }).then(function (data) {
      document.querySelector(`.recomment-form${comment_pk}`).reset();
      console.log(data.recomment_obj)
      let recommentLi = ''
      for (let key in data.recomment_obj) {

        if ('{{article.writer.pk}}' == data.recomment_obj[key]['writer_pk']) {
          recommentLi += `<li class="recomment-li recomment-li${key}">
          <span class="comment-profile-span">
          <img class="user-img comment-profile-img img${data.recomment_obj[key]['id']}" src="${data.recomment_obj[key]['user_img']}"  onerror="this.src='{% static 'img/감자.png' %}'"><strong
                class="owner">판매자</strong> <span>${data.recomment_obj[key]['created_at']}</span></span><br>
                `
        }
        else {
          recommentLi += `<li class="recomment-li recomment-li${key}">
          <span class="comment-profile-span">
          <img class="user-img comment-profile-img img${data.recomment_obj[key]['id']} "  src="${data.recomment_obj[key]['user_img']}" onerror="this.src='{% static 'img/감자.png' %}'">
                ${data.recomment_obj[key]['writer']} <span>${data.recomment_obj[key]['created_at']}</span></span>
                <br>
                `
        }
        if ('{{request.user.pk}}' == data.recomment_obj[key]['writer_pk']) {
          recommentLi += `
        <span class="comment-content">${data.recomment_obj[key]['content']}</span>
        <form class="delete-recomment-form delete-recomment-form${data.recomment_obj[key]['id']}" action="" method="POST">
          {% csrf_token %}
          <span class="comment-delete comment-delete${data.comment_data.id}"
                onclick="reCommentDelete('${data.recomment_obj[key]['id']}')">삭제</span></li>
              </form>
              `
        }
        else {
          recommentLi += `
        <span class="comment-content">${data.recomment_obj[key]['content']}</span>
              <span class="comment-reply comment-reply${data.comment_data.pk}" onclick="commentReply('${data.comment_data.id}')">답글</span></li>`
        }
      }
      document.querySelector(`.recomment-ul${comment_pk}`).innerHTML = recommentLi

    }).catch((error) => {
      console.log('error', error);
    })
  }


// 수정 ajax

function commentEditCancelBtn(comment_pk){
  event.preventDefault();
  document.querySelector(`.edit-comment-form${comment_pk}`).classList.add('non-display');
  document.querySelector(`.comment-content${comment_pk}`).classList.remove('non-display');
  document.querySelector(`.delete-comment-form${comment_pk}`).classList.remove('non-display');
  console.log('d')
}
function commentContentEditBtn(comment_pk){
  event.preventDefault();
  document.querySelector(`.edit-comment-form${comment_pk}`).classList.remove('non-display');
  document.querySelector(`.comment-content${comment_pk}`).classList.add('non-display');
  document.querySelector(`.delete-comment-form${comment_pk}`).classList.add('non-display');

  console.log('d');
}

function commentEditBtn(comment_pk){
  event.preventDefault();
  document.querySelector(`.edit-comment-form${comment_pk}`).addEventListener('submit',EditCommentForm(comment_pk));
}

function EditCommentForm(comment_pk){
event.preventDefault();
edit_comment = document.querySelector(`.edit_comment${comment_pk}`).value;
if (edit_comment == '') {
      return
}
document.querySelector(`.edit-comment-form${comment_pk}`).classList.add('non-display');
  document.querySelector(`.comment-content${comment_pk}`).classList.remove('non-display');
  document.querySelector(`.delete-comment-form${comment_pk}`).classList.remove('non-display');
let param = {
      'edit_comment': edit_comment,
      'comment_pk': comment_pk
    }
    let csrfValue = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    
    // ajax통신
    fetch("{% url 'social:edit' %}", {
      method: 'POST',
      headers: {
        "X-CSRFToken": csrfValue,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify(param),
    }).then(function (response) {
      console.log('reass', response)
      return response.json()
    }).then(function (data) {
      console.log(data)
      console.log(edit_comment = document.querySelector(`.edit_comment${comment_pk}`).value)
      document.querySelector(`.comment-content${comment_pk}`).innerText = edit_comment
     
    }).catch((error) => {
      console.log('error', error);
    })
  }
  

  // 삭제 ajax
  function commentDelete(comment_pk) {
    document.querySelector('.delete-comment-form').addEventListener('submit', deleteComment(comment_pk));
  }
  
  function deleteComment(comment_pk) {
    event.preventDefault();
    document.querySelector(`.comment-li${comment_pk}`).classList.add('non-display');

    let param = {
      'article_pk': '{{article.pk}}',
      'user_pk': '{{request.user.pk}}',
      'owner_pk': '{{article.writer.pk}}',
      'comment_pk': comment_pk
    }
    let csrfValue = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    
    // ajax통신
    fetch("{% url 'social:delete' %}", {
      method: 'POST',
      headers: {
        "X-CSRFToken": csrfValue,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify(param),
    }).then(function (response) {
      console.log('reass', response)
      return response.json()
    }).then(function (data) {
      console.log(data)
      console.log('{{comment_pk}}')
     
    }).catch((error) => {
      console.log('error', error);
    })
  }
  
function reCommentDelete(recomment_pk){
  document.querySelector(`.delete-recomment-form${recomment_pk}`).addEventListener('submit', deleteReComment(recomment_pk));
}
function deleteReComment(recomment_pk) {
    event.preventDefault();
    document.querySelector(`.recomment-li${recomment_pk}`).classList.add('non-display');

    let param = {
      'recomment_pk': recomment_pk,
      'msg':'recomment_delete',
    }
    let csrfValue = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    
    // ajax통신
    fetch("{% url 'social:delete' %}", {
      method: 'POST',
      headers: {
        "X-CSRFToken": csrfValue,
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify(param),
    }).then(function (response) {
      console.log('reass', response)
      return response.json()
    }).then(function (data) {
      console.log(data)
     
    }).catch((error) => {
      console.log('error', error);
    })
  }
  
</script>

{% endblock script %}